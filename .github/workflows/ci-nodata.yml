name: Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, windows-latest, macos-latest]

    # Set environment variables globally for the job
    env:
      # Keeps Windows encoding behavior consistent with your old script
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      # 1. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # 2. Set up Python 3.12 (Managed by uv)
      - name: Set up Python 3.12
        run: uv python install 3.12

      # 3. Install System Dependencies (Ubuntu Only)
      - name: Install system libraries (Ubuntu)
        if: contains(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1 libegl1

      # 4. Install Project Dependencies
      - name: Install dependencies
        run: uv sync --frozen

      # 5. Run Tests
      # 'uv run' executes pytest inside the environment created by 'uv sync'
      - name: Test with pytest
        run: uv run pytest -s
